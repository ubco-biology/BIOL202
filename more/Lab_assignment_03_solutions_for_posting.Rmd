---
title: "Lab Assignment 03 solutions"
author: "Jason Pither"
output:
  html_document:
    df_print: paged
  pdf_document:
    fig_caption: yes
  word_document:
    fig_caption: yes
    reference_docx: assignment_style_template.docx
---


```{r setup, include=FALSE}
# DO NOT ALTER CODE IN THIS CHUNK
knitr::opts_chunk$set(echo = TRUE)
library(tigerstats)
lattice.options(default.theme = standard.theme(color = FALSE))
```
This page was last updated on `r format(Sys.time(), '%B %d, %Y')`.

# Load libraries

```{r}
library(tigerstats)
library(visreg)
```

* * *

### Required data

```{r}
booby <- read.csv(url("https://people.ok.ubc.ca/jpither/datasets/booby.csv"), header = TRUE)
mammals <- read.csv(url("https://people.ok.ubc.ca/jpither/datasets/mammals.csv"), header = TRUE)
```

* * *

## Question 1 (5 marks)

> Is there an association between the number of visits experienced by nestling boobies and the future behaviour
of the same individuals as adults?

## Inspect the data:

```{r}
head(booby)
inspect(booby)
```

### Hypthesis statements

The `booby` data frame consists of 24 measurements of visits experienced by nestling boobies and the future behaviour of those individuals as adults. Since we are dealing with numeric variables, we conduct a Pearson correlation analysis, unless assumptions are not met, in which case we could perform a Spearman rank correlation analysis.

First, we state the null and alternative hypotheses.

H~0~: The number of Visits experienced by nestling boobies has no impact on their future behaviour ($\rho$ = 0).

H~A~: The number of visits experienced by nestling boobies impacts their future behaviour ($\rho \ne$ 0).

or 

H~0~: The number of Visits experienced by nestling boobies is not associated/correlated with future behaviour ($\rho$ = 0).

H~A~: The number of visits experienced by nestling boobies is associated/correlated with future behaviour ($\rho \ne$ 0).

And we set $\alpha$ = 0.05. 

***

### Data visualization

Visualize the data using a scatterplot to assess any association between the variables. 

```{r fig.asp = 1, fig.cap = "Figure 1: The association between a booby's adult behaviour and the number of times it was visited as a nestling for 24 boobies.", fig.width = 4.2, fig.height = 4}

plot(futureBehavior ~ nVisitsNestling, 
     data = booby,
     ylab = "Behaviour as an adult",
     xlab = "Visits experienced as a nestling (n)",
     pch = 1, 
     cex = 0.75,
     col = 'firebrick',
     las = 1
)

```

The association between the number of visits to a nestling booby and that booby's behaviour as an adult is positive, somewhat curved / non-linear, and weak to moderately strong (Figure 1). 

> Given the non-linear association, the best option is to conduct a Spearman rank correlation

### Option 1 - Assumptions assumed met (Incorrect option)

Assumptions of the test:

- Individuals were sampled randomly
- The association is linear - **THIS assumption is not met**
- Measurements have a bivariate normal distribution (See option 2)
- No "funnel" shape, apparent outliers, or non-linear association (Figure 1)

If proceeding under incorrect decision that assumptions met, then do Pearson:

```{r}
booby.cor <- cor.test(futureBehavior ~ nVisitsNestling, 
                      data = booby,
                      method = "pearson",
                      conf.level = 0.95)
booby.cor
```

### Conclusion 1

Adult booby behavior is significantly positively correlated with the number of visits to that individual as a nestling (Fig. 1; Pearson's *r* = `r round(booby.cor$estimate, 2)`; 95% confidence limits: `r round(booby.cor$conf.int[1], 3)`, `r round(booby.cor$conf.int[2], 3)`; df = `r booby.cor$parameter`; *P*-value = `r round(booby.cor$p.value, 3)`).

### Option 2 (Correct option)

The student can decide to do a Spearman correlation due to the non-linear association, and/or because they find that one of the variables is not normally distributed.  

Check the two variables for normality using the Shapiro-Wilk's test. First, the normality of `nVisitsNestling`:

```{r}
visits.shapiro <- shapiro.test(booby$nVisitsNestling)
```

The results of the Shapiro-Wilk's test show that the variable `nVisitsNestling` is consistent with being drawn from a normal distribution (*W* = `r round(visits.shapiro$statistic, 2)`; *P*-value = `r round(visits.shapiro$p.value, 3)`).  

Now, check the normality of `futureBehavior`:

```{r}
future.shapiro <- shapiro.test(booby$futureBehavior)
```

The `futureBehavior` variable is more questionable; The Shapiro-Wilk's test provides evidence that the `futureBehavior` data are not normally distributed (*W* = `r round(future.shapiro$statistic, 2)`; *P*-value = `r round(future.shapiro$p.value, 3)`). 

The relationship between the two variables appears to be monotonic (Figure 1), so we can use Spearman's rank correlation analysis.

Our new hypothesis statements:

H~0~: $\rho$~S~ = 0

H~A~: $\rho$~S~ $\ne$ 0

$\alpha$ = 0.05

```{r}
booby.spear <- cor.test(futureBehavior ~ nVisitsNestling, 
                      data = booby,
                      method = "spearman",
                      conf.level = 0.95)
booby.spear
```

### Conclusion 2

The rank of adult booby behavior is significantly positively correlated with the rank of visits to that individual as a nestling (Figure 1; Spearman *r~S~* = `r round(booby.spear$estimate, 2)`; n = 24; *P*-value = `r round(booby.spear$p.value, 3)`). 

OR

Adult booby behavior is significantly positively associated with the number of visits to that individual as a nestling (Figure 1; Spearman *r~S~* = `r round(booby.spear$estimate, 2)`; n = 24; *P*-value = `r round(booby.spear$p.value, 3)`). 


* * *

## Question 2 (7 marks)

> Can we predict average brain mass from average body mass for these mammal species?

Prediction requires a linear regression, which does not require a formal hypothesis test per se.  

$\alpha$ level: 0.05

## Inspect the data:

Start by inspecting the data (using `inspect` or `str`, the former preferred).

```{r}
inspect(mammals)
```

The data set consists of body mass and brain mass measurements for 62 different mammal species. No missing values or "NA" values.

### Visualize the data

We should visualize the data to try to detect any association between the two variables, and to help check for outliers.  

```{r fig.cap = "Figure 2: The association between brain mass (g) and body mass (kg) among 62 species of mammals.", fig.width = 4.2, fig.height = 4}
plot(brain_mass_g ~ body_mass_kg, data = mammals,
     ylab = "Species brain mass (g)",
     xlab = "Species body mass (kg)",
     pch = 1,
     cex = 0.5,
     col = "firebrick",
     las = 1)

```

Figure 2 shows that brain mass and body weight do not have a linear relationship, and data points are clumped, suggesting a skewed distribution of both variables. 

### Optional chunk - perform the regression analysis to check residuals

**NOTE: One could move straight to "Data Transformation"- that's fine!**

### Assumptions

1. Linear relationship between lion age and nose pigmentation proportion
2. Lion age is normally distributed at each value of pigmentation
3. The variance of lion age is the same along all pigmentation proportions (and linear)

* * *

We continue with the regression analysis in order to check assumptions.

```{r}
mammals.lm <- lm(brain_mass_g ~ body_mass_kg, data = mammals)
```

Store these residuals in the original `mammals` dataframe:

```{r}
mammals$mammals.lm.resids <- residuals(mammals.lm)
```

Check the normality of the residuals using a normal quantile plot.

```{r fig.cap = "Figure 3: Normal quantile plot of the residuals from a regression of age (years) on black nose pigmentation for 32 male lions.", fig.width = 4.2, fig.height = 4}
qqnorm(mammals$mammals.lm.resids)
qqline(mammals$mammals.lm.resids)
```

In the normal quantile plot, the residuals clearly do not follow the line (Figure 3). There is a curved pattern, indicating that a transformation is necessary. 

### Data transformation

One could evaluate the raw variables with histograms or normal quantile plots, but this is not ideal, as it is the _residuals_ that one needs to check. If checking the raw variables, then:

Visualize the variables to determine the type of transformation needed (again, not ideal).

```{r fig.cap = "Figure 4: Frequency distributions of the body mass (left) and brain mass (right) of 62 mammal species.", fig.width = 6.2, fig.height = 3}
par(mfrow = c(1,2))
hist(mammals$body_mass_kg, 
     main = "",
     las = 1, col = 'grey90',
     xlab = 'Body mass (kg)')
hist(mammals$brain_mass_g, main = "",
     las = 1, col = 'grey90',
     xlab = 'Brain mass (g)')
```

Figure 4 shows that the frequency distributions for both body mass and brain mass have dramatic right skews; a log transformation is likely to normalize the distributions for both variables.

```{r}
mammals$log.body.kg <- log(mammals$body_mass_kg)
mammals$log.brain.g <- log(mammals$brain_mass_g)
```

* * *

Have a look at the quantile plots for the log-transformed vectors.

```{r fig.cap = "Figure 5: The frequency distribtion of the log-transformed body mass (kg) of 62 mammal species (left) and the corresponding normal quantile plot (right).", fig.width = 6.2, fig.height = 3}
par(mfrow = c(1,2))
hist(mammals$log.body.kg, 
     main = "",
     las = 1, col = 'grey90',
     xlab = 'Body mass (kg) (log)')
qqnorm(mammals$log.body.kg, 
       main = "",
       las = 1,
       ylab = 'Body mass (kg) (log)',
       xlab = 'Normal quantile')
qqline(mammals$log.body.kg)
```

The log-transformed body mass data are much closer to normal, and the points in the normal quantile plot follow the line (Figure 5). 

```{r fig.cap = "Figure 6: The frequency distribtion of the log-transformed brain mass (g) of 62 mammal species (left) and the corresponding normal quantile plot (right).", fig.width = 6.2, fig.height = 3}
par(mfrow = c(1,2))
hist(mammals$log.brain.g, 
     main = "",
     las = 1, col = 'grey90',
     xlab = 'Brain mass (g) (log)')
qqnorm(mammals$log.brain.g, 
       main = "",
       las = 1,
       ylab = 'Brain mass (g) (log)',
       xlab = 'Normal quantile')
qqline(mammals$log.brain.g)
```

The log-transformed brain mass data appear normal, and the points in the normal quantile plot follow the line (Figure 6). 

### Re-visualize the data

```{r fig.cap = "Figure 7: The association between log-transformed brain mass and log-transformed body mass among 62 species of mammals.", fig.width = 4.2, fig.height = 4}
plot(log.brain.g ~ log.body.kg, data = mammals,
     ylab = "Species brain mass (g) (log)",
     xlab = "Species body mass (kg) (log)",
     pch = 1,
     cex = 0.5,
     col = "firebrick",
     las = 1)

```


Figure 7 shows that there is a strong positive relationship between the log-transformed brain mass (g) and log-transformed body weight (kg) in mammals. There are no obvious outliers to this association. To check the other assumptions of the regression analysis, we must run the regression analysis on the log-transformed to obtain the residuals. 

## Regression analysis

```{r}
mammals.lm <- lm(log.brain.g ~ log.body.kg, data = mammals)
```

Check the normality of the distribution of the residuals.

```{r fig.cap = "Figure 8: Normal quantile plot of the residuals from a regression of log-transformed brain mass (g) vs log-transformed body mass (kg) for 62 mammal species.", fig.width = 4.2, fig.height = 4}
mammals$weight.lm.resids <- residuals(mammals.lm)
qqnorm(mammals$weight.lm.resids, las = 1)
qqline(mammals$weight.lm.resids)
```

The residuals fall fairly consistently along the line in the normal quantile plot (Figure 8).  

Now, we check that the variance of brain mass is the same at all values of body mass. We can plot the residuals from the model above against the body mass.

```{r fig.cap = "Figure 9: Residual plot from a regression of brain mass on body weight for 62 mammal species.", fig.width = 4.2, fig.height = 4}
plot(weight.lm.resids ~ log.body.kg, data = mammals,
     ylab = "Residual",
     xlab = "Body mass (kg) (log))",
     pch = 1,
     cex = 0.5,
     col = "firebrick",
     las = 1)
abline(h = 0, lty = 2, col = 'grey20')
```

Figure 9 does not show any strong pattern of changing variance in brain mass along body mass, and the residuals do not appear to follow a curved pattern. We can proceed with the analysis.

We can simply output the summary of the previously-conducted regression analysis:

```{r}
mammals.summary <- summary(mammals.lm)
mammals.summary
```

Pull important results for later reporting (optional):

```{r}
mam.int <- round(mammals.summary$coefficients[1], 2)
mam.bod <- round(mammals.summary$coefficients[2], 2)
mam.F <- round(mammals.summary$fstatistic[1], 2)
mam.n <- nrow(mammals)
mam.r2 <- round(mammals.summary$r.squared, 1)
```

We also need to calculate the confidence intervals for the true slope ($\beta$); we can use the `confint` function.

```{r}
mammals.lm.conf <- confint(mammals.lm)
mammals.lm.conf
conf.low <- round(mammals.lm.conf[2,1], 3)
conf.upp <- round(mammals.lm.conf[2,2], 3)
```

We can now visualize the regression analysis.

```{r fig.cap = "Figure 10: Scatterplot of log-transformed brain mass (g) vs log-transformed body mass (kg) for 62 mammal species. Also shown is the significant least-square regression line (black solid line, see text for details) and the 95% confidence bands (grey shading)", fig.width = 4.2, fig.height = 4}
visreg(mammals.lm, alpha = 0.05,
       line = list(col = 'black'),
       points = list(cex = 0.75, 
                     pch = 1,
                     col = 'firebrick',
                     lwd = 1),
       las = 1,
       xlab = 'Body mass (kg) (log)',
       ylab = 'Brain mass (g) (log)'
)

```

### Concluding statement:

As shown in Figure 10, the relationship between log-transformed brain mass and log-transformed body mass is strong and positive; there are no obvious outliers to this relationship. Body mass is a significant predictor of brain mass among mammals (least-squares regression equation: log(*Brain mass)* = `r round(mam.int, 2)` + `r round(mam.bod, 2)`(log(*Body mass*); *F* = `r mam.F`; n = `r mam.n`; 95% confidence limits for the slope: `r conf.low`, `r conf.upp`; R^2^ = `r mam.r2`; `r ifelse(round(mammals.summary$coef[2,4],3) == 0, "P-value < 0.001", paste("P-value =", round(mammals.summary$coef[2,4],3)))`). The large R^2^ value should let us confidently predict mammal brain size for a given body mass.

* * *

Although there are a lot of steps shown for the regression answer above, one could simply have provided the following steps:

1. Shown the scatterplot, then recognized at this point that log-transformations were required
2. Do the log-transformations on both Y and X variables
3. Conduct the regression on the log-transformed data
4. Check the residuals for assumptions (using qqnorm plot and other residual plot), and confirm they are met
5. Re-plot the log-transformed relationship using the "visreg" command
6. Provide the concluding statement.